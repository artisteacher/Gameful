!function(t){tinymce.PluginManager.add("tma_annotate",function(n,e){function a(){i=!i,n.fire("tma_annotatehide",{state:i}),body=n.getBody(),i?(current=n.getContent(),tinymce.each(n.$("span.annotation"),function(t){n.dom.remove(t,!0)})):body?t(body).html(current):t(body).html("")}function o(){var t=this;n.on("tma_annotatehide",function(n){t.active(n.state)})}var i;e=TMA.myurl+"core/src/all/tinymce/annotate",n.addCommand("tma_cmd_hide",a),n.addButton("tma_annotate",{title:TMA.tooltips.annotation_create,image:e+"/img/annotation.png",onclick:function(){if(annotation="",a="#F0E465",node=n.selection.getNode(),nodeName=node.nodeName,"SPAN"==nodeName&&(nodeDataAnnotation=t(node).attr("data-annotation"),nodeDataStyle=t(node).css("background-color"),nodeDataAnnotation)){annotation=nodeDataAnnotation;var e=document.createElement("canvas").getContext("2d");e.strokeStyle=nodeDataStyle;var a=e.strokeStyle}var o=n.selection.getContent(),i;o.length>0||"annotation"==node.className?("annotation"==node.className&&(o=node.innerHTML),n.windowManager.open({title:TMA.tooltips.annotation_settings,body:[{type:"textbox",name:"annotation",label:TMA.settings.setting_annotation,value:annotation},{type:"colorpicker",name:"annotationbg",label:TMA.settings.setting_background,value:a}],onsubmit:function(e){if(!e.data.annotation)return n.windowManager.alert(TMA.errors.missing_fields),!1;var a=e.data.annotation;t(node).attr("data-annotation")&&n.dom.remove(node),n.selection.setContent('<span class="annotation" data-author="'+TMA.author+'" data-annotation="'+a.replace(/"/g,"&quot;")+'" style="background-color:'+e.data.annotationbg+'">'+o+"</span>")}})):n.windowManager.alert(TMA.errors.missing_annotation,!1)}}),n.addButton("tma_annotatedelete",{title:TMA.tooltips.annotation_delete,image:e+"/img/annotation-delete.png",onclick:function(){var e=n.selection.getContent(),a=e.length,o=n.selection.getNode();a>0||"annotation"==o.className?("annotation"==o.className&&(e=o.innerHTML),deletionNode=n.selection.getNode(),replaceNode=deletionNode,t(deletionNode).attr("style",""),n.dom.remove(replaceNode,deletionNode)):n.windowManager.alert(TMA.errors.missing_selected)}}),n.addButton("tma_annotatehide",{title:TMA.tooltips.annotation_hide,image:e+"/img/annotation-hide.png",cmd:"tma_cmd_hide",onPostRender:o})})}(jQuery);